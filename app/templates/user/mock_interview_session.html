{% extends "user/user_base.html" %}

{% block title %}AI Interview Coach | Aura Sentient OS{% endblock %}

{% block styles %}
<style>
    .interview-wrapper {
        perspective: 1000px;
        height: calc(100vh - 120px);
        display: flex;
        gap: 20px;
        padding: 10px;
    }

    /* Main Stage */
    .stage-container {
        flex: 1;
        position: relative;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        transition: all 0.5s var(--ease-spring);
    }

    .ai-orb-container {
        position: relative;
        width: 250px;
        height: 250px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 40px;
    }

    #ai-orb {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: var(--bg-surface);
        border: 2px solid var(--neural-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 40px var(--neural-glow);
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 2;
    }

    .orb-pulse {
        position: absolute;
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 2px solid var(--neural-primary);
        opacity: 0.5;
        animation: orb-ripple 2s infinite;
    }

    @keyframes orb-ripple {
        0% { transform: scale(1); opacity: 0.5; }
        100% { transform: scale(2.5); opacity: 0; }
    }

    #visualizer-canvas {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        z-index: 1;
        pointer-events: none;
    }

    .status-badge {
        background: rgba(0,0,0,0.3);
        backdrop-filter: blur(10px);
        padding: 8px 20px;
        border-radius: 99px;
        border: 1px solid var(--glass-border);
        font-size: 0.85rem;
        letter-spacing: 1px;
        text-transform: uppercase;
        color: var(--neural-primary);
        margin-bottom: 20px;
    }

    .question-box {
        max-width: 600px;
        text-align: center;
        padding: 20px;
    }

    .question-text {
        font-size: 1.5rem;
        font-weight: 600;
        line-height: 1.4;
        color: #fff;
        text-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }

    /* Sidebars */
    .sidebar-right {
        width: 320px;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    /* Webcam PIP */
    .webcam-panel {
        aspect-ratio: 4/3;
        overflow: hidden;
        border-radius: 20px;
        position: relative;
    }

    #webcam-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1);
    }

    /* Analysis Stats */
    .analysis-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .sentiment-bar {
        height: 6px;
        background: rgba(255,255,255,0.1);
        border-radius: 3px;
        overflow: hidden;
        margin: 10px 0;
    }

    #sentiment-fill {
        height: 100%;
        width: 0%;
        background: var(--neural-primary);
        transition: width 0.8s var(--ease-spring), background-color 0.5s ease;
    }

    /* Controls */
    .controls-dock {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 15px;
        padding: 10px 20px;
        z-index: 100;
    }

    .btn-circle {
        width: 54px;
        height: 54px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50% !important;
    }

    .btn-circle.active {
        background: var(--neural-primary) !important;
        box-shadow: 0 0 20px var(--neural-glow);
    }

    /* Transcript overlay */
    .transcript-drawer {
        position: absolute;
        top: 20px;
        left: 20px;
        width: 300px;
        max-height: 400px;
        overflow-y: auto;
        z-index: 10;
        display: none;
    }

    .transcript-msg {
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 12px;
        font-size: 0.85rem;
    }

    .msg-ai { background: rgba(99, 102, 241, 0.1); border-left: 3px solid var(--neural-primary); }
    .msg-user { background: rgba(255, 255, 255, 0.05); border-right: 3px solid #fff; text-align: right; }

    /* Manual Input Overlay */
    .input-overlay {
        position: absolute;
        bottom: 100px;
        width: 100%;
        max-width: 500px;
        display: none;
    }
</style>
{% endblock %}

{% block user_content %}
<div class="interview-wrapper animate-in">
    <!-- Transcript Drawer -->
    <div id="transcript-drawer" class="transcript-drawer glass-panel p-3">
        <h6 class="text-muted small fw-bold mb-3">SESSION TRANSCRIPT</h6>
        <div id="transcript-content"></div>
    </div>

    <!-- Main Stage -->
    <div class="stage-container">
        <div id="status-badge" class="status-badge">System Ready</div>
        
        <div class="ai-orb-container">
            <canvas id="visualizer-canvas"></canvas>
            <div id="orb-pulse" class="orb-pulse d-none"></div>
            <div id="ai-orb">
                <span data-feather="cpu" style="width: 48px; height: 48px; color: var(--neural-primary);"></span>
            </div>
        </div>

        <div class="question-box">
            <h2 id="question-text" class="question-text">Click Start to begin your session</h2>
        </div>

        <div id="input-overlay" class="input-overlay">
            <div class="glass-panel p-2 d-flex align-items-center">
                <input type="text" id="text-input" class="form-control bg-transparent text-white border-0 shadow-none" placeholder="Type your answer...">
                <button id="btn-send-text" class="btn btn-primary rounded-circle ms-2" style="width: 40px; height: 40px;">
                    <span data-feather="send" style="width: 16px;"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Sidebar -->
    <div class="sidebar-right">
        <div class="webcam-panel glass-panel">
            <video id="webcam-video" autoplay playsinline muted></video>
            <div class="position-absolute bottom-0 start-0 w-100 p-2 bg-dark bg-opacity-50 text-center small">
                LIVE VIDEO ANALYSIS
            </div>
        </div>

        <div class="analysis-panel glass-panel p-4">
            <h6 class="fw-bold mb-4 text-gradient">Real-time Analysis</h6>
            
            <div class="mb-4">
                <div class="d-flex justify-content-between small mb-1">
                    <span class="text-muted">Confidence Score</span>
                    <span id="score-val" class="fw-bold text-primary">0/10</span>
                </div>
                <div class="sentiment-bar">
                    <div id="sentiment-fill"></div>
                </div>
            </div>

            <div class="mb-4">
                <label class="small text-muted mb-2">Sentiment</label>
                <div id="sentiment-tag" class="badge bg-secondary bg-opacity-25 text-white w-100 py-2">Neutral</div>
            </div>

            <div class="mb-4">
                <label class="small text-muted mb-2">Live Feedback</label>
                <p id="feedback-text" class="small text-muted italic">Waiting for response...</p>
            </div>

            <div class="mt-auto">
                <div id="tip-box" class="alert alert-primary bg-opacity-10 border-glass py-2 small d-none">
                    <span class="fw-bold">TIP:</span> <span id="tip-text">...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div class="controls-dock glass-panel">
        <button id="btn-start" class="btn btn-glass btn-circle bg-success text-white" title="Start Session">
            <span data-feather="play"></span>
        </button>
        
        <button id="btn-mic" class="btn btn-glass btn-circle" title="Toggle Mic" disabled>
            <span data-feather="mic"></span>
        </button>

        <button id="btn-input" class="btn btn-glass btn-circle" title="Text Input">
            <span data-feather="keyboard"></span>
        </button>

        <button id="btn-transcript" class="btn btn-glass btn-circle" title="Toggle Transcript">
            <span data-feather="list"></span>
        </button>

        <button id="btn-finish" class="btn btn-glass btn-circle btn-danger text-white d-none" title="Finish & Save">
            <span data-feather="check"></span>
        </button>

        <button id="btn-cancel" class="btn btn-glass btn-circle btn-outline-danger" title="Exit">
            <span data-feather="x"></span>
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    const socket = io();
    
    // UI Elements
    const btnStart = document.getElementById('btn-start');
    const btnMic = document.getElementById('btn-mic');
    const btnInput = document.getElementById('btn-input');
    const btnFinish = document.getElementById('btn-finish');
    const btnCancel = document.getElementById('btn-cancel');
    const btnTranscript = document.getElementById('btn-transcript');
    const btnSendText = document.getElementById('btn-send-text');
    
    const orb = document.getElementById('ai-orb');
    const pulse = document.getElementById('orb-pulse');
    const statusBadge = document.getElementById('status-badge');
    const questionText = document.getElementById('question-text');
    const textInput = document.getElementById('text-input');
    const inputOverlay = document.getElementById('input-overlay');
    const transcriptDrawer = document.getElementById('transcript-drawer');
    const transcriptContent = document.getElementById('transcript-content');
    const visualizerCanvas = document.getElementById('visualizer-canvas');
    
    // Analysis Elements
    const scoreVal = document.getElementById('score-val');
    const sentimentFill = document.getElementById('sentiment-fill');
    const sentimentTag = document.getElementById('sentiment-tag');
    const feedbackText = document.getElementById('feedback-text');
    const tipBox = document.getElementById('tip-box');
    const tipText = document.getElementById('tip-text');
    
    // State
    let isActive = false;
    let isListening = false;
    let recognition;
    let synth = window.speechSynthesis;

    // --- Visualizer Logic ---
    const ctx = visualizerCanvas.getContext('2d');
    function initVisualizer() {
        visualizerCanvas.width = 250;
        visualizerCanvas.height = 250;
        drawVisualizer();
    }

    function drawVisualizer() {
        if (!isActive) return;
        requestAnimationFrame(drawVisualizer);
        
        ctx.clearRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
        const centerX = visualizerCanvas.width / 2;
        const centerY = visualizerCanvas.height / 2;
        const radius = 60;

        if (synth.speaking || isListening) {
            const time = Date.now() * 0.005;
            ctx.beginPath();
            ctx.strokeStyle = isListening ? 'rgba(16, 185, 129, 0.4)' : 'rgba(99, 102, 241, 0.4)';
            ctx.lineWidth = 2;
            
            for (let i = 0; i < 360; i += 5) {
                const angle = i * Math.PI / 180;
                const offset = Math.sin(angle * 5 + time * 2) * (isListening ? 15 : 10);
                const x = centerX + (radius + offset) * Math.cos(angle);
                const y = centerY + (radius + offset) * Math.sin(angle);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.closePath();
            ctx.stroke();
        }
    }
    
    // --- Speech Recognition ---
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        recognition.onstart = () => {
            isListening = true;
            btnMic.classList.add('active');
            statusBadge.innerText = "Listening...";
            statusBadge.style.color = "var(--neural-secondary)";
            pulse.classList.remove('d-none');
        };

        recognition.onend = () => {
            isListening = false;
            btnMic.classList.remove('active');
            if (isActive) {
                statusBadge.innerText = "Analyzing...";
            }
            pulse.classList.add('d-none');
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            addTranscript('You', transcript);
            sendAnswer(transcript);
        };

        recognition.onerror = (event) => {
            console.error("Speech Error:", event.error);
            statusBadge.innerText = "Mic Error: " + event.error;
            btnMic.classList.remove('active');
        };
    }

    // --- Core Functions ---
    function speak(text) {
        if (synth.speaking) synth.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        
        utterance.onstart = () => {
            statusBadge.innerText = "AI Speaking...";
            orb.style.borderColor = "var(--neural-primary)";
            orb.style.boxShadow = "0 0 50px var(--neural-glow)";
        };

        utterance.onend = () => {
            if (isActive) {
                statusBadge.innerText = "Your Turn";
                orb.style.boxShadow = "0 0 20px var(--neural-glow)";
                // Auto-trigger mic if it's the beginning or if user prefers
                // For "clean" flow, we let the user click or we can auto-start
                // let's try auto-starting for better flow
                try { recognition.start(); } catch(e) {}
            }
        };

        synth.speak(utterance);
        addTranscript('AI', text);
    }

    function addTranscript(who, text) {
        const div = document.createElement('div');
        div.className = `transcript-msg ${who === 'AI' ? 'msg-ai' : 'msg-user'}`;
        div.innerHTML = `<strong>${who}:</strong> ${text}`;
        transcriptContent.appendChild(div);
        transcriptDrawer.scrollTop = transcriptDrawer.scrollHeight;
    }

    function sendAnswer(text) {
        if (!text.trim()) return;
        socket.emit('send_answer', { answer: text });
        inputOverlay.style.display = 'none';
    }

    // --- UI Listeners ---
    btnStart.addEventListener('click', async () => {
        isActive = true;
        btnStart.classList.add('d-none');
        btnFinish.classList.remove('d-none');
        btnMic.disabled = false;
        
        initVisualizer();
        if (typeof feather !== 'undefined') feather.replace();
        
        // Start Webcam
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            document.getElementById('webcam-video').srcObject = stream;
        } catch (e) { console.warn("Camera access denied"); }
        
        socket.emit('start_interview', {});
        statusBadge.innerText = "Initializing...";
    });

    btnMic.addEventListener('click', () => {
        if (isListening) recognition.stop();
        else {
            try { recognition.start(); } catch(e) { console.error(e); }
        }
    });

    btnInput.addEventListener('click', () => {
        inputOverlay.style.display = inputOverlay.style.display === 'none' ? 'block' : 'none';
        if (inputOverlay.style.display === 'block') textInput.focus();
    });

    btnTranscript.addEventListener('click', () => {
        transcriptDrawer.style.display = transcriptDrawer.style.display === 'none' ? 'block' : 'none';
        btnTranscript.classList.toggle('active');
    });

    btnSendText.addEventListener('click', () => {
        const val = textInput.value;
        if (val) {
            addTranscript('You', val);
            sendAnswer(val);
            textInput.value = '';
        }
    });

    textInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') btnSendText.click();
    });

    btnFinish.addEventListener('click', () => {
        if (confirm("Finish session and generate report?")) {
            isActive = false;
            if (synth.speaking) synth.cancel();
            if (recognition) recognition.stop();
            
            btnFinish.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            btnFinish.disabled = true;
            
            socket.emit('end_interview', {});
        }
    });

    btnCancel.addEventListener('click', () => {
        if (confirm("Exit session? Progress will not be saved.")) {
            window.location.href = "{{ url_for('user.dashboard') }}";
        }
    });

    // --- Socket Events ---
    socket.on('interview_question', (data) => {
        questionText.innerText = data.question;
        speak(data.question);
    });

    socket.on('sentiment_feedback', (data) => {
        // Update Score
        const score = data.score || 0;
        scoreVal.innerText = `${score}/10`;
        sentimentFill.style.width = (score * 10) + "%";
        
        // Update Color based on score
        if (score >= 8) sentimentFill.style.backgroundColor = "#10b981";
        else if (score >= 5) sentimentFill.style.backgroundColor = "#f59e0b";
        else sentimentFill.style.backgroundColor = "#ef4444";
        
        // Update Tags
        sentimentTag.innerText = data.sentiment.toUpperCase();
        feedbackText.innerText = data.feedback;
        
        if (data.improvement_tip) {
            tipBox.classList.remove('d-none');
            tipText.innerText = data.improvement_tip;
        }

        // Orb reaction
        if (data.sentiment === 'positive') {
            orb.style.backgroundColor = "rgba(16, 185, 129, 0.1)";
        } else if (data.sentiment === 'negative') {
            orb.style.backgroundColor = "rgba(239, 68, 68, 0.1)";
        }
        
        setTimeout(() => {
            orb.style.backgroundColor = "var(--bg-surface)";
        }, 3000);
    });

    socket.on('report_ready', (data) => {
        if (data.redirect_url) {
            window.location.href = data.redirect_url;
        } else {
            alert("Error: " + (data.error || "Report failed"));
            btnFinish.innerHTML = '<span data-feather="check"></span>';
            btnFinish.disabled = false;
        }
    });

</script>
{% endblock %}


        