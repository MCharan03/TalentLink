{% extends "base.html" %}

{% block title %}My Dashboard{% endblock %}

{% block content %}
<div class="mb-4">
    <h2>My Dashboard</h2>
    <p class="text-muted">Welcome back, {{ current_user.username }}!</p>
</div>

<ul class="nav nav-tabs mb-4" id="dashboardTabs" role="tablist">
  <li class="nav-item">
    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#past-analyses" type="button">Past Analyses</button>
  </li>
  <li class="nav-item">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#job-opportunities" type="button">Job Opportunities</button>
  </li>
  <li class="nav-item">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#my-progress" type="button">My Progress</button>
  </li>
  <li class="nav-item">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#past-interviews" type="button">Past Interview Analysis</button>
  </li>
  <li class="nav-item">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#resume-builder" type="button">Resume Builder</button>
  </li>
  <li class="nav-item">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#linkedin-builder" type="button">LinkedIn Builder</button>
  </li>
</ul>

<div class="tab-content" id="dashboardTabsContent">
  <!-- Past Analyses -->
  <div class="tab-pane fade show active" id="past-analyses">
      {% if analyses %}
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Email_ID</th>
              <th>ai_feedback</th>
              <th>Timestamp</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for item in analyses %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ item.analysis_result.get('name', 'N/A') }}</td>
              <td>{{ item.analysis_result.get('email', 'N/A') }}</td>
              <td class="text-truncate" style="max-width: 300px;">{{ item.analysis_result.ai_summary }}</td>
              <td>{{ item.uploaded_at.strftime('%Y-%m-%d %H:%M') }}</td>
              <td>
                  <a href="{{ url_for('user.resume_analysis_result', user_data_id=item.id) }}" class="btn btn-sm btn-primary">View</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <p class="text-muted">No past analyses found.</p>
      {% endif %}
  </div>

  <!-- Job Opportunities -->
  <div class="tab-pane fade" id="job-opportunities">
      {% if applications %}
      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Date Applied</th>
              <th>Job Title</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for app in applications %}
            <tr>
              <td>{{ app.applied_at.strftime('%Y-%m-%d') }}</td>
              <td>{{ app.job.title }}</td>
              <td><span class="badge bg-secondary">{{ app.status }}</span></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <p class="text-muted">No applications yet. <a href="{{ url_for('user.jobs') }}">Find jobs</a>.</p>
      {% endif %}
  </div>

  <!-- My Progress -->
  <div class="tab-pane fade" id="my-progress">
      {% if resume_scores|length > 1 %}
          <div class="card p-4">
              <canvas id="userProgressChart"></canvas>
          </div>
          <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
          <script>
              document.addEventListener("DOMContentLoaded", function() {
                  const ctx = document.getElementById('userProgressChart').getContext('2d');
                  const data = {{ resume_scores | tojson }};
                  new Chart(ctx, {
                      type: 'line',
                      data: {
                          labels: data.map(d => d.timestamp),
                          datasets: [{
                              label: 'Score',
                              data: data.map(d => d.score),
                              borderColor: '#ff4b4b',
                              fill: true
                          }]
                      }
                  });
              });
          </script>
      {% else %}
          <p class="text-muted">Need at least two analyses to show progress.</p>
      {% endif %}
  </div>

  <!-- Past Interview Analysis -->
  <div class="tab-pane fade" id="past-interviews">
      {% if interviews %}
       <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Date Started</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for interview in interviews %}
            <tr>
              <td>{{ interview.started_at.strftime('%Y-%m-%d %H:%M') }}</td>
              <td><span class="badge bg-success">Completed</span></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <p class="text-muted">No interviews yet.</p>
      {% endif %}
  </div>

  <!-- Resume Builder -->
  <div class="tab-pane fade" id="resume-builder">
      {% with form=resume_form %}
          {% include "user/resume_builder_partial.html" %}
      {% endwith %}
  </div>

  <!-- LinkedIn Builder -->
  <div class="tab-pane fade" id="linkedin-builder">
      {% with form=linkedin_form %}
          {% include "user/linkedin_builder_partial.html" %}
      {% endwith %}
  </div>
</div>
{% endblock %}
