{% extends "base.html" %}

{% block content %}
<div class="container py-5">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="display-5 fw-bold text-gradient">AI Interview Coach</h1>
            <p class="text-muted">Real-time feedback on your speaking confidence and content.</p>
        </div>
    </div>

    <div class="row justify-content-center">
        <!-- Interview Area -->
        <div class="col-md-8">
            <div class="card border-0 shadow-lg border-glass" style="min-height: 500px;">
                <div class="card-body d-flex flex-column">
                    
                    <!-- AI Avatar / Status -->
                    <div class="text-center mb-4">
                        <div id="ai-status-indicator" class="rounded-circle d-inline-flex align-items-center justify-content-center mb-3" 
                             style="width: 80px; height: 80px; background: var(--bg-surface); border: 2px solid var(--primary); transition: all 0.3s;">
                             <span data-feather="mic" class="text-primary" style="width: 32px; height: 32px;"></span>
                        </div>
                        <h4 id="question-display" class="fw-bold mb-2">Ready to start?</h4>
                        <p id="listening-status" class="text-muted small">Click the mic to begin.</p>
                    </div>

                    <!-- Chat / Feedback Stream -->
                    <div id="feedback-stream" class="flex-grow-1 overflow-auto mb-4 p-3 rounded bg-secondary bg-opacity-10 border border-glass" style="max-height: 300px;">
                        <div class="text-center text-muted small mt-5">
                            Transcript and feedback will appear here...
                        </div>
                    </div>

                    <!-- Controls -->
                    <div class="mt-auto d-flex justify-content-center gap-3">
                        <button id="btn-start" class="btn btn-primary btn-lg rounded-pill px-5 d-flex align-items-center gap-2">
                            <span data-feather="play"></span> Start Session
                        </button>
                        <button id="btn-stop" class="btn btn-danger btn-lg rounded-pill px-5 d-none align-items-center gap-2">
                            <span data-feather="square"></span> Stop
                        </button>
                        <button id="btn-finish" class="btn btn-success btn-lg rounded-pill px-5 d-none align-items-center gap-2">
                            <span data-feather="check"></span> Finish & Report
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Metrics (Optional Sidebar) -->
        <div class="col-md-4 mt-4 mt-md-0">
            <div class="card border-0 shadow border-glass h-100">
                <div class="card-header bg-transparent border-bottom border-glass fw-bold">
                    Live Analysis
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <label class="small text-muted mb-1">Confidence Score</label>
                        <div class="progress" style="height: 10px;">
                            <div id="score-bar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="fw-bold small">Latest Feedback</h6>
                        <p id="latest-feedback" class="small text-muted">No data yet.</p>
                    </div>

                    <div class="mb-3">
                        <h6 class="fw-bold small">Improvement Tip</h6>
                        <div id="latest-tip" class="alert alert-info py-2 small border-0">
                            Waiting for your answer...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    const socket = io();
    const btnStart = document.getElementById('btn-start');
    const btnStop = document.getElementById('btn-stop');
    const btnFinish = document.getElementById('btn-finish');
    const statusText = document.getElementById('listening-status');
    const indicator = document.getElementById('ai-status-indicator');
    const questionDisplay = document.getElementById('question-display');
    const feedbackStream = document.getElementById('feedback-stream');
    
    // ... Speech Recognition and TTS Setup ...

    // UI Events
    btnStart.addEventListener('click', () => {
        // Initial Start
        socket.emit('start_interview', {});
        btnStart.classList.add('d-none');
        btnStop.classList.remove('d-none');
        btnFinish.classList.remove('d-none');
        statusText.innerText = "Connecting...";
    });

    btnStop.addEventListener('click', () => {
        if (recognition) recognition.stop();
        if (synth.speaking) synth.cancel();
        btnStart.classList.remove('d-none');
        btnStop.classList.add('d-none');
        btnFinish.classList.add('d-none');
        statusText.innerText = "Session Stopped.";
    });

    btnFinish.addEventListener('click', () => {
        if (recognition) recognition.stop();
        if (synth.speaking) synth.cancel();
        btnFinish.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...';
        btnFinish.disabled = true;
        socket.emit('end_interview', {});
    });

    // Socket Events
    socket.on('connect', () => {
        console.log("Connected to AI Coach");
    });

    socket.on('interview_question', (data) => {
        if (data.error) {
            addMessage('System', 'Error: ' + data.error);
            return;
        }

        currentQuestion = data.question;
        questionDisplay.innerText = currentQuestion;
        
        // Add to chat
        addMessage('AI Coach', currentQuestion, true);
        
        // Speak it
        speak(currentQuestion);
    });

    socket.on('report_ready', (data) => {
        if (data.redirect_url) {
            window.location.href = data.redirect_url;
        } else {
            alert("Error generating report: " + (data.error || "Unknown error"));
            btnFinish.innerHTML = '<span data-feather="check"></span> Finish & Report';
            btnFinish.disabled = false;
        }
    });

    function addMessage(sender, text, isAi = false) {
        const div = document.createElement('div');
        div.className = `mb-3 ${isAi ? 'text-start' : 'text-end'}`; // Corrected alignment
        div.innerHTML = `
            <small class="fw-bold ${isAi ? 'text-primary' : 'text-muted'}">${sender}</small>
            <div class="p-3 rounded-3 mt-1 shadow-sm ${isAi ? 'bg-primary bg-opacity-10 text-main border border-primary border-opacity-25' : 'bg-secondary bg-opacity-10 text-white border border-white border-opacity-10'}" 
                 style="display: inline-block; max-width: 85%; text-align: left;">
                ${text}
            </div>
        `;
        feedbackStream.appendChild(div);
        feedbackStream.scrollTop = feedbackStream.scrollHeight;
        
        // Clear placeholder
        const placeholder = feedbackStream.querySelector('.text-center');
        if (placeholder) placeholder.remove();
    }
</script>

<style>
    @keyframes pulse {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(var(--primary-rgb), 0.7); }
        70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(var(--primary-rgb), 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(var(--primary-rgb), 0); }
    }
    .pulse-animation {
        animation: pulse 1.5s infinite;
    }
</style>
{% endblock %}
