{% extends "user/user_base.html" %}

{% block title %}Career Assistant{% endblock %}

{% block user_content %}
<div class="row justify-content-center h-100">
    <div class="col-md-10 h-100">
        <div class="card h-100 shadow-lg border-0">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-robot me-2"></i> Career Agent</h5>
                <span class="badge bg-light text-primary">Beta</span>
            </div>
            <div class="card-body d-flex flex-column" style="height: 70vh;">
                <div id="chat-history" class="flex-grow-1 overflow-auto mb-3 p-3" style="background: #f8f9fa; border-radius: 10px;">
                    <!-- Messages go here -->
                    <div class="d-flex flex-row justify-content-start mb-3">
                        <div class="p-3 ms-3" style="border-radius: 15px; background-color: rgba(57, 192, 237,.2);">
                            <p class="small mb-0">Hello! I'm your personal Career Agent. I can help you find jobs, analyze your resume, or prepare for interviews. How can I assist you today?</p>
                        </div>
                    </div>
                </div>
                
                <div class="input-group">
                    <input type="text" id="user-input" class="form-control form-control-lg" placeholder="Ask me anything (e.g., 'Find Python jobs', 'Review my resume')..." onkeypress="handleKeyPress(event)">
                    <button class="btn btn-primary" type="button" id="send-btn" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const chatHistory = document.getElementById('chat-history');
    const userInput = document.getElementById('user-input');
    let messageHistory = [];

    function appendMessage(role, text) {
        const div = document.createElement('div');
        div.className = `d-flex flex-row justify-content-${role === 'user' ? 'end' : 'start'} mb-3`;
        
        const contentDiv = document.createElement('div');
        contentDiv.className = `p-3 ${role === 'user' ? 'me-3 bg-primary text-white' : 'ms-3'}`;
        contentDiv.style.borderRadius = '15px';
        if (role === 'model') contentDiv.style.backgroundColor = 'rgba(57, 192, 237,.2)';
        
        contentDiv.innerHTML = `<p class="small mb-0">${text.replace(/\n/g, '<br>')}</p>`;
        
        div.appendChild(contentDiv);
        chatHistory.appendChild(div);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        appendMessage('user', text);
        userInput.value = '';
        
        // Simple loading state
        const loadingId = 'loading-' + Date.now();
        const loadingDiv = document.createElement('div');
        loadingDiv.id = loadingId;
        loadingDiv.className = "d-flex flex-row justify-content-start mb-3";
        loadingDiv.innerHTML = '<div class="p-3 ms-3" style="border-radius: 15px; background-color: rgba(57, 192, 237,.2);"><i class="fas fa-spinner fa-spin"></i> Thinking...</div>';
        chatHistory.appendChild(loadingDiv);
        
        fetch("{{ url_for('user.api_agent_chat') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': "{{ csrf_token() }}"
            },
            body: JSON.stringify({
                message: text,
                history: messageHistory
            })
        })
        .then(res => res.json())
        .then(data => {
            document.getElementById(loadingId).remove();
            appendMessage('model', data.response);
            
            // Update local history
            messageHistory.push({role: 'user', content: text});
            messageHistory.push({role: 'model', content: data.response});
        })
        .catch(err => {
            document.getElementById(loadingId).remove();
            appendMessage('model', "Sorry, I'm having trouble connecting right now.");
        });
    }

    function handleKeyPress(e) {
        if (e.key === 'Enter') sendMessage();
    }
</script>
{% endblock %}
