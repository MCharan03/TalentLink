{% extends "base.html" %}

{% block title %}System Flowchart{% endblock %}

{% block content %}
<style>
    /* Scoped styles for flowchart to avoid breaking base layout */
    .flowchart-wrapper {
        font-family: 'Inter', sans-serif;
        display: flex;
        justify-content: center;
        padding: 2rem 0;
        background-color: var(--bg-body);
        min-height: 80vh;
    }
    
    .flowchart-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        padding-bottom: 80px;
        width: 100%;
        max-width: 800px;
    }

    .f-node {
        background: var(--bg-card);
        border: 1px solid var(--border);
        color: var(--text-main);
        padding: 15px 25px;
        border-radius: 12px;
        text-align: center;
        width: 280px;
        position: relative;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: all 0.4s ease-in-out;
        opacity: 0;
        transform: translateY(20px);
        cursor: pointer;
        z-index: 2;
    }
    
    .f-node.visible { opacity: 1; transform: translateY(0); }
    .f-node.active { border-color: var(--primary); box-shadow: 0 0 15px rgba(var(--primary-rgb), 0.3); transform: scale(1.05); }
    
    .f-node.start, .f-node.end { background: var(--primary); color: white; font-weight: 600; border: none; }
    .f-node.decision { background: var(--secondary); color: white; border: none; }
    .f-node.continue { background: #198754; color: white; border: none; }

    .f-connector { 
        width: 2px; 
        background-color: var(--border); 
        position: relative; 
        transition: height 0.4s ease; 
        height: 0; 
        z-index: 1;
    }
    .f-connector.visible { height: 40px; }
    .f-connector::after { 
        content: ''; 
        position: absolute; 
        left: 50%; 
        bottom: -1px; 
        transform: translateX(-50%); 
        border-left: 7px solid transparent; 
        border-right: 7px solid transparent; 
        border-top: 9px solid var(--border); 
        transition: opacity 0.4s ease; 
        opacity: 0; 
    }
    .f-connector.visible::after { opacity: 1; }

    .role-paths { display: flex; gap: 40px; align-items: flex-start; justify-content: center; width: 100%; }
    .f-path { display: flex; flex-direction: column; align-items: center; gap: 20px; transition: opacity 0.4s ease; }
    .f-path.dimmed { opacity: 0.2; pointer-events: none; }
    
    .path-title { font-weight: 600; color: var(--primary); margin-bottom: 10px; opacity: 0; transition: opacity 0.4s ease; }
    .path-title.visible { opacity: 1; }

    .f-btn-group { display: none; gap: 15px; margin-top: 15px; justify-content: center; }
    .f-btn-group.visible { display: flex; }

    .f-btn {
        background-color: var(--bg-card);
        color: var(--primary);
        border: 1px solid var(--primary);
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s ease;
    }
    .f-btn:hover { background-color: var(--primary); color: white; }
    
    #nav-controls { 
        position: fixed; 
        bottom: 30px; 
        left: 50%; 
        transform: translateX(-50%); 
        display: flex; 
        gap: 15px; 
        background: rgba(255, 255, 255, 0.9); 
        backdrop-filter: blur(5px); 
        padding: 10px 20px; 
        border-radius: 50px; 
        box-shadow: 0 4px 20px rgba(0,0,0,0.15); 
        z-index: 50; 
        opacity: 0; 
        transition: opacity 0.5s ease; 
        pointer-events: none; 
    }
    #nav-controls.visible { opacity: 1; pointer-events: auto; }
</style>

<div class="flowchart-wrapper">
    <div class="flowchart-container">
        <div id="n-start" class="f-node start">Start: Smart Resume Analyzer</div>
        
        <div id="c-init" class="f-connector"></div>
        <div id="n-init" class="f-node process">Initialization & Auth</div>
        
        <div id="c-decision" class="f-connector"></div>
        <div id="n-decision" class="f-node decision">
            Select Role
            <div id="decision-buttons" class="f-btn-group">
                <button id="btn-user" class="f-btn">User Path</button>
                <button id="btn-admin" class="f-btn">Admin Path</button>
            </div>
        </div>

        <div class="role-paths">
            <!-- User Path -->
            <div id="path-user" class="f-path">
                <div id="pt-user" class="path-title">User Journey</div>
                
                <div id="c-user-1" class="f-connector"></div>
                <div id="n-user-1" class="f-node process">Upload Resume (PDF)</div>
                
                <div id="c-user-2" class="f-connector"></div>
                <div id="n-user-2" class="f-node process">AI Parsing & Scoring</div>
                
                <div id="c-user-3" class="f-connector"></div>
                <div id="n-user-3" class="f-node process">View Analysis & Roadmap</div>
                
                <div id="c-user-4" class="f-connector"></div>
                <div id="n-user-4" class="f-node process">Take Mock Interview</div>
            </div>

            <!-- Admin Path -->
            <div id="path-admin" class="f-path">
                <div id="pt-admin" class="path-title">Admin Journey</div>
                
                <div id="c-admin-1" class="f-connector"></div>
                <div id="n-admin-1" class="f-node process">Admin Login</div>
                
                <div id="c-admin-2" class="f-connector"></div>
                <div id="n-admin-2" class="f-node process">View Dashboard Stats</div>
                
                <div id="c-admin-3" class="f-connector"></div>
                <div id="n-admin-3" class="f-node process">Manage Users & Jobs</div>
                
                <div id="c-admin-4" class="f-connector"></div>
                <div id="n-admin-4" class="f-node process">Export Data</div>
            </div>
        </div>

        <div id="n-continue" class="f-node continue">
            Path Complete!
            <div id="continue-buttons" class="f-btn-group">
                <button id="btn-restart" class="f-btn" style="border-color: white; color: white;">Restart</button>
            </div>
        </div>
    </div>
</div>

<div id="nav-controls">
    <button id="prev-btn" class="btn btn-sm btn-outline-dark rounded-circle"><span data-feather="arrow-left"></span></button>
    <span class="align-self-center small fw-bold text-dark">Navigate</span>
    <button id="next-btn" class="btn btn-sm btn-outline-dark rounded-circle"><span data-feather="arrow-right"></span></button>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const sequence = [
        ['n-start'], 
        ['c-init', 'n-init'], 
        ['c-decision', 'n-decision']
    ];
    
    const paths = {
        user: [
            ['pt-user', 'c-user-1', 'n-user-1'],
            ['c-user-2', 'n-user-2'],
            ['c-user-3', 'n-user-3'],
            ['c-user-4', 'n-user-4']
        ],
        admin: [
            ['pt-admin', 'c-admin-1', 'n-admin-1'],
            ['c-admin-2', 'n-admin-2'],
            ['c-admin-3', 'n-admin-3'],
            ['c-admin-4', 'n-admin-4']
        ]
    };
    
    let step = -1;
    let pathStep = -1;
    let selectedPath = null;
    let maxSteps = sequence.length;

    function update() {
        // Reset everything first (simple approach)
        document.querySelectorAll('.f-node, .f-connector, .path-title').forEach(el => {
            el.classList.remove('visible', 'active');
        });
        document.querySelectorAll('.f-btn-group').forEach(el => el.classList.remove('visible'));
        document.getElementById('path-user').classList.remove('dimmed');
        document.getElementById('path-admin').classList.remove('dimmed');

        // Show base sequence up to current step
        for(let i=0; i<=step; i++) {
            if(sequence[i]) sequence[i].forEach(id => document.getElementById(id).classList.add('visible'));
        }

        // Show path if selected
        if(selectedPath) {
            document.getElementById(selectedPath === 'user' ? 'path-admin' : 'path-user').classList.add('dimmed');
            for(let i=0; i<=pathStep; i++) {
                if(paths[selectedPath][i]) paths[selectedPath][i].forEach(id => document.getElementById(id).classList.add('visible'));
            }
        }

        // Show controls
        const lastNodeId = selectedPath 
            ? paths[selectedPath][pathStep] ? paths[selectedPath][pathStep][paths[selectedPath][pathStep].length-1] : null 
            : sequence[step] ? sequence[step][sequence[step].length-1] : null;

        if(lastNodeId) {
            document.getElementById(lastNodeId).classList.add('active');
            
            if(lastNodeId === 'n-decision' && !selectedPath) {
                document.getElementById('decision-buttons').classList.add('visible');
            }
            if(lastNodeId === 'n-user-4' || lastNodeId === 'n-admin-4') {
                document.getElementById('n-continue').classList.add('visible', 'active');
                document.getElementById('continue-buttons').classList.add('visible');
            }
        }

        document.getElementById('nav-controls').classList.add('visible');
    }

    function next() {
        if(!selectedPath) {
            if(step < sequence.length - 1) step++;
        } else {
            if(pathStep < paths[selectedPath].length - 1) pathStep++;
        }
        update();
    }

    function prev() {
        if(pathStep >= 0) {
            pathStep--;
        } else if(selectedPath) {
            selectedPath = null; // Back to decision
        } else if(step >= 0) {
            step--;
        }
        update();
    }

    // Controls
    document.getElementById('next-btn').onclick = next;
    document.getElementById('prev-btn').onclick = prev;
    document.getElementById('btn-user').onclick = () => { selectedPath = 'user'; pathStep = -1; next(); };
    document.getElementById('btn-admin').onclick = () => { selectedPath = 'admin'; pathStep = -1; next(); };
    document.getElementById('btn-restart').onclick = () => { step = -1; pathStep = -1; selectedPath = null; next(); };

    // Init
    setTimeout(next, 500);
});
</script>
{% endblock %}