{% extends "base.html" %}

{% block title %}{{ title }} | TalentLink{% endblock %}

{% block content %}
<div class="py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold text-main">{{ title }}</h2>
                <a href="{{ url_for('recruiter.manage_jobs') }}" class="btn btn-outline-secondary">
                    <span data-feather="arrow-left" class="me-1"></span> Back
                </a>
            </div>

            <div class="card p-4">
                <form method="POST">
                    {{ form.hidden_tag() }}

                    <div class="mb-4">
                        <label for="title" class="form-label fw-bold">Job Title</label>
                        {{ form.title(class="form-control form-control-lg", placeholder="e.g. Senior Frontend Engineer",
                        id="title") }}
                        {% for error in form.title.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>

                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label for="description" class="form-label fw-bold mb-0">Job Description</label>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="generateDesc()">
                                <span data-feather="cpu" class="me-1" style="width: 14px;"></span> AI Generate
                            </button>
                        </div>
                        {{ form.description(class="form-control", rows="10", placeholder="Detailed requirements,
                        responsibilities, and perks...", id="description") }}
                        {% for error in form.description.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>

                    <div class="card bg-surface border-glass mb-4 p-3">
                        <h6 class="fw-bold mb-3"><span data-feather="terminal" class="me-2"></span>Recruitment Protocol</h6>
                        
                        <div class="form-check form-switch mb-3">
                            {{ form.is_ai_round_enabled(class="form-check-input", role="switch", id="aiSwitch") }}
                            <label class="form-check-label fw-bold" for="aiSwitch">Enable AI Autonomous Interview (1st Round)</label>
                        </div>

                        <div id="aiSettings" style="display: {% if form.is_ai_round_enabled.data %}block{% else %}none{% endif %};">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label small text-muted">Assign AI Recruiter Agent</label>
                                    {{ form.ai_interviewer_name(class="form-select bg-surface border-secondary") }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small text-muted">Interviewer Tone</label>
                                    {{ form.ai_interview_tone(class="form-select bg-surface border-secondary") }}
                                </div>
                            </div>
                            <p class="small text-muted mt-2">
                                <i data-feather="info" style="width: 12px;"></i> This agent will autonomously conduct the 1st round when you move a candidate to 'AI Interview' status.
                            </p>
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            {% if 'Edit' in title %}
                            <span data-feather="save" class="me-1"></span> Update Job
                            {% else %}
                            <span data-feather="plus-circle" class="me-1"></span> Create Job
                            {% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function generateDesc() {
        const title = document.getElementById('title').value;
        if (!title) {
            alert('Please enter a job title first.');
            return;
        }

        const btn = event.currentTarget;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Generating...';
        btn.disabled = true;

        fetch("{{ url_for('admin.generate_job_desc_api') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': "{{ csrf_token() }}"
            },
            body: JSON.stringify({ title: title })
        })
            .then(res => {
                if (res.status === 403) throw new Error("Permission Denied. Contact Admin.");
                return res.json();
            })
            .then(data => {
                if (data.description) {
                    document.getElementById('description').value = data.description;
                } else {
                    alert('Error generating description.');
                }
            })
            .catch(err => alert(err))
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }
    
        // Toggle AI settings display
        document.getElementById('aiSwitch').addEventListener('change', function() {
            const settings = document.getElementById('aiSettings');
            settings.style.display = this.checked ? 'block' : 'none';
        });
    </script>
    {% endblock %}
    